
#Whatâ€™s Changed:
#Replaced golang base image with Alpine 3.19 for a lightweight footprint.

#Switched Java setup to use Alpine's native openjdk15 package to resolve java not found errors.

#Used multi-stage build to separate build tools from the runtime, keeping the final image minimal.

#Cleaned up ENV and PATH handling for Maven and Java.

#Maintained support for VERSION, TARGETARCH, and TARGETOS build arguments.


FROM alpine:3.19 AS builder

RUN apk add --no-cache \
    openjdk15 \
    curl \
    tar \
    bash \
    go \
    libc6-compat

ENV JAVA_HOME=/usr/lib/jvm/java-15-openjdk \
    MAVEN_VERSION=3.6.3 \
    M2_HOME=/opt/apache-maven-3.6.3 \
    PATH=$PATH:/opt/apache-maven-3.6.3/bin:/usr/lib/jvm/java-15-openjdk/bin

RUN curl -fsSL https://repo1.maven.org/maven2/org/apache/maven/apache-maven/${MAVEN_VERSION}/apache-maven-${MAVEN_VERSION}-bin.tar.gz \
    | tar -xz -C /opt

ARG VERSION
ARG TARGETARCH
ARG TARGETOS

RUN echo "Using JX version ${VERSION} for ${TARGETOS}/${TARGETARCH}" && \
    mkdir -p /home/.jx3 && \
    curl -L https://github.com/jenkins-x/jx/releases/download/v${VERSION}/jx-${TARGETOS}-${TARGETARCH}.tar.gz \
    | tar -xz && \
    mv jx /usr/bin

RUN jx upgrade plugins --mandatory

FROM alpine:3.19

COPY --from=builder /usr/bin/jx /usr/bin/jx
COPY --from=builder /opt/apache-maven-3.6.3 /opt/apache-maven-3.6.3
COPY --from=builder /usr/lib/jvm/java-15-openjdk /usr/lib/jvm/java-15-openjdk

ENV JAVA_HOME=/usr/lib/jvm/java-15-openjdk \
    M2_HOME=/opt/apache-maven-3.6.3 \
    PATH=$PATH:/opt/apache-maven-3.6.3/bin:/usr/lib/jvm/java-15-openjdk/bin

ENTRYPOINT ["jx"]
#Easier to maintain and extend with Go or Maven projects in the future.
