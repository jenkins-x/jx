name: Release
permissions:
  contents: read # to fetch code (actions/checkout)
jobs:
  release:
    if: github.repository_owner == 'osamamagdy'
    runs-on: ubuntu-latest
    steps:
    - name: Build and push jx
      uses: docker/build-push-action@v3
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64
        push: true
        build-args: |
          VERSION=${{ steps.prep.outputs.version }}
        tags: |
          ghcr.io/osamamagdy/jx:latest
          ghcr.io/osamamagdy/jx:${{ steps.prep.outputs.version }}
    - name: Generate and Push SBOM
      uses: docker://ghcr.io/oras-project/oras:v0.13.0
      with:
        entrypoint: .github/workflows/osamamagdy/sbom-container.sh
      env:
        GITHUB_TOKEN: ${{ secrets.GIT_BOT_TOKEN }}
        GIT_USERNAME: osamamagdy
        DOCKER_REGISTRY_ORG: osamamagdy
        REPO_NAME: ${{ github.event.repository.name }}
        VERSION: ${{ steps.prep.outputs.version }}
    - name: cosign-installer
      uses: sigstore/cosign-installer@v2.0.0
    - name: Sign the published Docker image
      env:
        COSIGN_PWD: ${{secrets.COSIGN_PWD}}
        COSIGN_PRIVATE_KEY: ${{secrets.COSIGN_PRIVATE_KEY}}
        GITHUB_TOKEN: ${{ secrets.GIT_BOT_TOKEN }}
        GIT_USERNAME: osamamagdy
        DOCKER_REGISTRY_ORG: osamamagdy
        REPO_NAME: ${{ github.event.repository.name }}
        VERSION: ${{ steps.prep.outputs.version }}
      run: cosign sign --key=env://COSIGN_PRIVATE_KEY ghcr.io/$DOCKER_REGISTRY_ORG/$REPO_NAME:$VERSION


"on":
  push:
    branches:
    - main
    - master
